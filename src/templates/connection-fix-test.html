<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Line Fix Test</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/components.css">
    <style>
        .test-container {
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }
        
        .chart-container {
            position: relative;
            min-height: 800px;
            border: 1px solid #ddd;
            background: white;
            overflow: auto;
            margin: 20px 0;
        }
        
        .controls {
            margin: 20px 0;
        }
        
        .controls label {
            margin-right: 20px;
        }
        
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            border: 1px solid #ccc;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .connection-line {
            background-color: #ff0000 !important; /* Red for debugging */
        }
    </style>
</head>
<body>
    <h1>Connection Line Fix Test</h1>
    
    <div class="test-container">
        <div class="controls">
            <button id="refreshBtn">Refresh Chart</button>
            <button id="clearBtn">Clear Chart</button>
            <label>
                <input type="checkbox" id="debugMode" checked> Debug Mode
            </label>
        </div>
        
        <div class="debug-info">
            <h4>Debug Info</h4>
            <div id="debugInfo"></div>
        </div>
        
        <div id="testChart" class="chart-container"></div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/data-processor.js"></script>
    <script src="../js/layout-calculator.js"></script>
    <script src="../js/chart-renderer.js"></script>
    
    <script>
        class ConnectionFixTest {
            constructor() {
                this.container = document.getElementById('testChart');
                this.setupEventListeners();
                this.createTestData();
                this.renderChart();
            }
            
            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.renderChart());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearChart());
                document.getElementById('debugMode').addEventListener('change', () => this.renderChart());
            }
            
            createTestData() {
                // Create complex test data with multiple levels and siblings
                this.processedData = {
                    organizations: new Map([
                        ['ROOT', {
                            name: 'ROOT',
                            longName: 'Root Organization',
                            teamLongName: 'Root Organization',
                            level: 1,
                            parent: null,
                            managers: [{ name: 'CEO', role: 'Chief Executive Officer' }],
                            advisors: [],
                            colors: { borderColor: '#2196f3', backgroundColor: '#e3f2fd' }
                        }],
                        ['PROD', {
                            name: 'PROD',
                            longName: 'Production Division',
                            teamLongName: 'Production Division',
                            level: 2,
                            parent: 'ROOT',
                            managers: [{ name: 'Prod Manager', role: 'Division Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['SALES', {
                            name: 'SALES',
                            longName: 'Sales Division',
                            teamLongName: 'Sales Division',
                            level: 2,
                            parent: 'ROOT',
                            managers: [{ name: 'Sales Manager', role: 'Division Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['CMG', {
                            name: 'CMG',
                            longName: 'Cimanggis Factory',
                            teamLongName: 'Cimanggis Factory',
                            level: 3,
                            parent: 'PROD',
                            managers: [{ name: 'CMG Manager', role: 'Factory Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['CBT', {
                            name: 'CBT',
                            longName: 'Cibitun Factory',
                            teamLongName: 'Cibitun Factory',
                            level: 3,
                            parent: 'PROD',
                            managers: [{ name: 'CBT Manager', role: 'Factory Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['NORTH', {
                            name: 'NORTH',
                            longName: 'North Sales',
                            teamLongName: 'North Sales Region',
                            level: 3,
                            parent: 'SALES',
                            managers: [{ name: 'North Manager', role: 'Regional Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['SOUTH', {
                            name: 'SOUTH',
                            longName: 'South Sales',
                            teamLongName: 'South Sales Region',
                            level: 3,
                            parent: 'SALES',
                            managers: [{ name: 'South Manager', role: 'Regional Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['PF1', {
                            name: 'PF1',
                            longName: 'Plastic Fastener Line 1',
                            teamLongName: 'Plastic Fastener Line 1',
                            level: 4,
                            parent: 'CMG',
                            managers: [{ name: 'PF1 Supervisor', role: 'Line Supervisor' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['PF2', {
                            name: 'PF2',
                            longName: 'Plastic Fastener Line 2',
                            teamLongName: 'Plastic Fastener Line 2',
                            level: 4,
                            parent: 'CMG',
                            managers: [{ name: 'PF2 Supervisor', role: 'Line Supervisor' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['QC', {
                            name: 'QC',
                            longName: 'Quality Control',
                            teamLongName: 'Quality Control Team',
                            level: 4,
                            parent: 'CMG',
                            managers: [{ name: 'QC Manager', role: 'QC Manager' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['MT1', {
                            name: 'MT1',
                            longName: 'Metal Fastener Line 1',
                            teamLongName: 'Metal Fastener Line 1',
                            level: 4,
                            parent: 'CBT',
                            managers: [{ name: 'MT1 Supervisor', role: 'Line Supervisor' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['MT2', {
                            name: 'MT2',
                            longName: 'Metal Fastener Line 2',
                            teamLongName: 'Metal Fastener Line 2',
                            level: 4,
                            parent: 'CBT',
                            managers: [{ name: 'MT2 Supervisor', role: 'Line Supervisor' }],
                            advisors: [],
                            colors: {}
                        }],
                        ['ZC', {
                            name: 'ZC',
                            longName: 'Zipper Chain Production',
                            teamLongName: 'Zipper Chain Production Team',
                            level: 6,
                            parent: 'PF1',
                            managers: [{ name: 'ZC Leader', role: 'Team Leader' }],
                            advisors: [],
                            colors: { borderColor: '#ff9800', backgroundColor: '#fff3e0' }
                        }]
                    ]),
                    hierarchy: new Map([
                        ['ROOT', ['PROD', 'SALES']],
                        ['PROD', ['CMG', 'CBT']],
                        ['SALES', ['NORTH', 'SOUTH']],
                        ['CMG', ['PF1', 'PF2', 'QC']],
                        ['CBT', ['MT1', 'MT2']],
                        ['PF1', ['ZC']]
                    ])
                };
                
                this.targetOrgs = ['ROOT', 'PROD', 'SALES', 'CMG', 'CBT', 'NORTH', 'SOUTH', 'PF1', 'PF2', 'QC', 'MT1', 'MT2', 'ZC'];
            }
            
            renderChart() {
                const debugMode = document.getElementById('debugMode').checked;
                
                // Set debug mode
                if (typeof CONFIG !== 'undefined' && CONFIG.DEBUG) {
                    CONFIG.DEBUG.LOG_LAYOUT_CALCULATION = debugMode;
                    CONFIG.DEBUG.LOG_RENDERING = debugMode;
                }
                
                // Update styles
                const chartRenderer = new ChartRenderer(this.container);
                chartRenderer.updateStyles('medium', 'medium');
                
                // Calculate layout
                const layoutCalculator = new LayoutCalculator(this.processedData);
                const layout = layoutCalculator.calculateLayout(this.targetOrgs, null, {});
                
                // Render chart
                chartRenderer.render(layout, this.processedData, {});
                
                // Update debug info
                this.updateDebugInfo(layout);
            }
            
            clearChart() {
                this.container.innerHTML = '';
                document.getElementById('debugInfo').innerHTML = 'Chart cleared';
            }
            
            updateDebugInfo(layout) {
                const connectionLines = this.container.querySelectorAll('.connection-line');
                const horizontalLines = this.container.querySelectorAll('.connection-line.horizontal');
                const verticalLines = this.container.querySelectorAll('.connection-line.vertical');
                
                const debugInfo = {
                    'Nodes': layout.nodes.length,
                    'Expected Connections': layout.connections.length,
                    'Drawn Connection Lines': connectionLines.length,
                    'Horizontal Lines': horizontalLines.length,
                    'Vertical Lines': verticalLines.length
                };
                
                // Check for missing connections
                const expectedConnections = layout.connections.map(conn => `${conn.from.org} → ${conn.to.org}`);
                const missingConnections = [];
                
                expectedConnections.forEach(expected => {
                    const [fromOrg, toOrg] = expected.split(' → ');
                    const connectionExists = Array.from(connectionLines).some(line => {
                        const lineFrom = line.getAttribute('data-from');
                        const lineTo = line.getAttribute('data-to');
                        return lineFrom === fromOrg && lineTo === toOrg;
                    });
                    
                    if (!connectionExists) {
                        missingConnections.push(expected);
                    }
                });
                
                if (missingConnections.length > 0) {
                    debugInfo['❌ Missing Connections'] = missingConnections.join(', ');
                } else {
                    debugInfo['✅ All Connections'] = 'Present';
                }
                
                // Check ZC positioning
                const zcNode = layout.nodes.find(n => n.org === 'ZC');
                if (zcNode) {
                    debugInfo['ZC Position'] = `X=${zcNode.x}, Y=${zcNode.y}, Level=${zcNode.level}`;
                }
                
                document.getElementById('debugInfo').innerHTML = 
                    Object.entries(debugInfo)
                        .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
                        .join('');
            }
        }
        
        // Initialize test
        window.addEventListener('DOMContentLoaded', () => {
            new ConnectionFixTest();
        });
    </script>
</body>
</html>