<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Layout Test</title>
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/components.css">
</head>
<body>
    <div id="app">
        <h1>New Layout Test - CBT/CMG Ordering Fix</h1>
        <div class="controls">
            <label>
                Level Limit: 
                <select id="levelLimit">
                    <option value="5">Up to Level 5</option>
                    <option value="6">Up to Level 6</option>
                </select>
            </label>
            <button id="renderButton">Render Chart</button>
        </div>
        <div id="chart-container" class="chart-container">
            <div id="orgChart" class="org-chart"></div>
        </div>
    </div>

    <!-- Include all necessary JavaScript files -->
    <script src="src/js/config.js"></script>
    <script src="src/js/data-processor.js"></script>
    <script src="src/js/layout-calculator.js"></script>
    <script src="src/js/chart-renderer.js"></script>

    <script>
        // Test data matching the user's organization structure
        const fullTestData = [
            // Level 1
            { level: 1, empId: '', name: 'Factory Manager', nameEn: '', grade: '', teamId: '', teamLongName: 'Production', callName: 'Production', parent: '', role: 'Factory manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            
            // Level 2 (siblings under Production) - CBT first for left positioning
            { level: 3, empId: '', name: 'Hindam', nameEn: '', grade: '', teamId: '', teamLongName: 'Chemical Business Team', callName: 'CBT', parent: 'Production', role: 'deputy factory manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            { level: 3, empId: '', name: 'KBU', nameEn: '', grade: '', teamId: '', teamLongName: 'Chemical Management Group', callName: 'CMG', parent: 'Production', role: 'deputy factory manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            
            // Level 3 - CBT children (positioned first for left placement)
            { level: 4, empId: '', name: 'Arsadi', nameEn: '', grade: '', teamId: '', teamLongName: 'PPD2 Department', callName: 'PPD2', parent: 'CBT', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            { level: 4, empId: '', name: 'Arsadi', nameEn: '', grade: '', teamId: '', teamLongName: 'T&P Department', callName: 'T&P', parent: 'CBT', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            { level: 4, empId: '', name: 'Dedy', nameEn: '', grade: '', teamId: '', teamLongName: 'Utility Department', callName: 'Utility', parent: 'CBT', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            
            // Level 3 - CMG children
            { level: 4, empId: '', name: 'Kurniawan', nameEn: '', grade: '', teamId: '', teamLongName: 'Dyeing Department', callName: 'Dyeing', parent: 'CMG', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            { level: 4, empId: '', name: 'Latifah', nameEn: '', grade: '', teamId: '', teamLongName: 'PE Department', callName: 'PE', parent: 'CMG', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            { level: 4, empId: '', name: 'Abi', nameEn: '', grade: '', teamId: '', teamLongName: 'PPD1 Department', callName: 'PPD1', parent: 'CMG', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            
            // Level 4 - ZC under CMG (this is the problematic one)
            { level: 6, empId: '', name: 'Januar', nameEn: '', grade: '', teamId: '', teamLongName: 'ZC Department', callName: 'ZC', parent: 'CMG', role: 'Department Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' },
            
            // Additional test data
            { level: 5, empId: '', name: 'Ade', nameEn: '', grade: '', teamId: '', teamLongName: 'Roll Chain Section', callName: 'Roll Chain', parent: 'Dyeing', role: 'Section Manager', roleJp: '', borderColor: '', backgroundColor: '', headerTextColor: '', teamBossFlag: 'Y', concurrent: '' }
        ];

        // Initialize components
        const chartContainer = document.getElementById('orgChart');
        const renderer = new ChartRenderer(chartContainer);
        const dataProcessor = new DataProcessor();
        const layoutCalculator = new LayoutCalculator(null);

        function renderChart() {
            const levelLimit = parseInt(document.getElementById('levelLimit').value);
            
            // Filter data by level limit
            const filteredData = fullTestData.filter(item => item.level <= levelLimit);
            
            console.log(`Rendering with level limit: ${levelLimit}`);
            console.log('Filtered data:', filteredData.map(item => `${item.callName} (Level ${item.level})`));
            
            // Process data
            const processedData = dataProcessor.processData(filteredData);
            layoutCalculator.processedData = processedData;
            
            // Get target organizations
            const targetOrgs = filteredData.map(item => item.callName);
            
            // Calculate layout
            const layout = layoutCalculator.calculateLayout(targetOrgs, null, {});
            
            // Render chart
            renderer.render(layout, processedData, {});
            
            // Log the X positions for debugging
            setTimeout(() => {
                console.log('\n=== Final positions ===');
                const boxes = chartContainer.querySelectorAll('.org-box');
                const positions = [];
                boxes.forEach(box => {
                    const callName = box.getAttribute('data-call-name');
                    const x = parseInt(box.style.left);
                    positions.push({ callName, x });
                });
                
                positions.sort((a, b) => a.x - b.x);
                positions.forEach(pos => {
                    console.log(`${pos.callName}: X=${pos.x}`);
                });
            }, 100);
        }

        // Event listeners
        document.getElementById('renderButton').addEventListener('click', renderChart);
        document.getElementById('levelLimit').addEventListener('change', renderChart);

        // Initial render
        renderChart();
    </script>
</body>
</html>