<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Line Bug Fix Test</title>
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/components.css">
</head>
<body>
    <div id="app">
        <h1>Organization Chart - Double Line Bug Fix Test</h1>
        <div class="controls">
            <label>
                <input type="checkbox" id="hideManagersToggle"> Hide Managers Mode
            </label>
            <button id="testButton">Reload Chart</button>
        </div>
        <div id="chart-container" class="chart-container">
            <div id="orgChart" class="org-chart"></div>
        </div>
    </div>

    <!-- Include all necessary JavaScript files -->
    <script src="src/js/config.js"></script>
    <script src="src/js/data-processor.js"></script>
    <script src="src/js/layout-calculator.js"></script>
    <script src="src/js/chart-renderer.js"></script>

    <script>
        // Test data for demonstration
        const testData = [
            { org: 'CEO', parent: '', manager: 'John Doe', role: 'CEO', level: 1 },
            { org: 'CTO', parent: 'CEO', manager: 'Jane Smith', role: 'CTO', level: 2 },
            { org: 'CFO', parent: 'CEO', manager: 'Bob Johnson', role: 'CFO', level: 2 },
            { org: 'ENG1', parent: 'CTO', manager: 'Alice Brown', role: 'Manager', level: 3 },
            { org: 'ENG2', parent: 'CTO', manager: 'Charlie Wilson', role: 'Manager', level: 3 },
            { org: 'FIN1', parent: 'CFO', manager: 'David Lee', role: 'Manager', level: 3 }
        ];

        // Initialize components
        const chartContainer = document.getElementById('orgChart');
        const renderer = new ChartRenderer(chartContainer);
        const dataProcessor = new DataProcessor();
        const layoutCalculator = new LayoutCalculator(null);

        // Process test data
        const processedData = dataProcessor.processData(testData);
        layoutCalculator.processedData = processedData;

        function renderChart() {
            const hideManagers = document.getElementById('hideManagersToggle').checked;
            const targetOrgs = ['CEO', 'CTO', 'CFO', 'ENG1', 'ENG2', 'FIN1'];
            
            console.log('Rendering chart with hideManagers =', hideManagers);
            
            // Calculate layout
            const layout = layoutCalculator.calculateLayout(targetOrgs, null, { hideManagers });
            
            // Render chart
            renderer.render(layout, processedData, { hideManagers });
            
            // Count connection lines after a delay to ensure all are rendered
            setTimeout(() => {
                const horizontalLines = chartContainer.querySelectorAll('.connection-line.horizontal');
                const verticalLines = chartContainer.querySelectorAll('.connection-line.vertical');
                
                console.log(`Connection lines rendered:`, {
                    horizontal: horizontalLines.length,
                    vertical: verticalLines.length,
                    total: horizontalLines.length + verticalLines.length
                });
                
                // Check for duplicate lines (same position and size)
                const duplicates = checkForDuplicateLines();
                if (duplicates.length > 0) {
                    console.warn('Duplicate lines found:', duplicates);
                } else {
                    console.log('âœ… No duplicate lines detected');
                }
            }, 200);
        }

        function checkForDuplicateLines() {
            const lines = chartContainer.querySelectorAll('.connection-line');
            const positions = new Map();
            const duplicates = [];

            lines.forEach((line, index) => {
                const key = `${line.style.left}_${line.style.top}_${line.style.width}_${line.style.height}_${line.className}`;
                
                if (positions.has(key)) {
                    duplicates.push({
                        original: positions.get(key),
                        duplicate: index,
                        position: key
                    });
                } else {
                    positions.set(key, index);
                }
            });

            return duplicates;
        }

        // Event listeners
        document.getElementById('hideManagersToggle').addEventListener('change', renderChart);
        document.getElementById('testButton').addEventListener('click', renderChart);

        // Initial render
        renderChart();
    </script>
</body>
</html>